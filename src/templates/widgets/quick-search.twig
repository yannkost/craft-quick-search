{# Quick Search Widget Template #}

<div class="quick-search-widget" data-widget-id="{{ widget.id }}">
    {% if showSearch or showSections == 'search' %}
        <div class="quick-search-widget-search">
            <div class="quick-search-widget-search-wrapper">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="quick-search-widget-search-icon">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                <input type="text" class="quick-search-widget-search-input" placeholder="{{ 'Search entries...'|t('quick-search') }}" data-widget-search="{{ widget.id }}">
            </div>
            <div class="quick-search-widget-results" data-widget-results="{{ widget.id }}" style="display: none;"></div>
        </div>
    {% endif %}

    {% if showSections == 'both' or showSections == 'history' %}
        <div class="quick-search-widget-section">
            <h4 class="quick-search-widget-section-title">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                {{ 'History'|t('quick-search') }}
            </h4>
            {% if history|length %}
                <ul class="quick-search-widget-list">
                    {% for entry in history %}
                        <li class="quick-search-widget-item">
                            <a href="{{ entry.url }}" class="quick-search-widget-link">
                                <span class="quick-search-widget-title">{{ entry.title }}</span>
                                <span class="quick-search-widget-meta">
                                    <span class="quick-search-widget-section-name">{{ entry.section.name ?? '' }}</span>
                                    <span class="quick-search-widget-status {{ entry.status }}">{{ entry.status }}</span>
                                </span>
                            </a>
                        </li>
                    {% endfor %}
                </ul>
                {% if history|length >= historyLimit %}
                    <div class="quick-search-widget-show-more">
                        <button type="button" class="btn small" onclick="window.quickAccessOverlayInstance && window.quickAccessOverlayInstance.show()">
                            {{ 'Show more...'|t('quick-search') }}
                        </button>
                    </div>
                {% endif %}
            {% else %}
                <p class="quick-search-widget-empty">{{ 'No recent entries'|t('quick-search') }}</p>
            {% endif %}
        </div>
    {% endif %}

    {% if showSections == 'both' or showSections == 'favorites' %}
        <div class="quick-search-widget-section">
            <h4 class="quick-search-widget-section-title">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                </svg>
                {{ 'Favorites'|t('quick-search') }}
            </h4>
            {% if favorites|length %}
                <ul class="quick-search-widget-list">
                    {% for entry in favorites %}
                        <li class="quick-search-widget-item">
                            <a href="{{ entry.url }}" class="quick-search-widget-link">
                                <span class="quick-search-widget-title">{{ entry.title }}</span>
                                <span class="quick-search-widget-meta">
                                    <span class="quick-search-widget-section-name">{{ entry.section.name ?? '' }}</span>
                                    <span class="quick-search-widget-status {{ entry.status }}">{{ entry.status }}</span>
                                </span>
                            </a>
                        </li>
                    {% endfor %}
                </ul>
                {% if favorites|length >= favoritesLimit %}
                    <div class="quick-search-widget-show-more">
                        <button type="button" class="btn small" onclick="window.quickAccessOverlayInstance && window.quickAccessOverlayInstance.show()">
                            {{ 'Show more...'|t('quick-search') }}
                        </button>
                    </div>
                {% endif %}
            {% else %}
                <p class="quick-search-widget-empty">{{ 'No favorites yet'|t('quick-search') }}</p>
            {% endif %}
        </div>
    {% endif %}

    {% if quickAccessEnabled %}
        <div class="quick-search-widget-footer">
            <button type="button" class="btn small" onclick="window.quickAccessOverlayInstance && window.quickAccessOverlayInstance.show()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 12px; height: 12px; margin-right: 4px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
                {{ 'Quick Access'|t('quick-search') }}
                <span class="quick-search-widget-shortcut">{{ shortcut|upper }}</span>
            </button>
        </div>
    {% endif %}
</div>

<style>
.quick-search-widget {
    padding: 0;
}

.quick-search-widget-section {
    margin-bottom: 16px;
}

.quick-search-widget-section:last-of-type {
    margin-bottom: 12px;
}

.quick-search-widget-section-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    font-weight: 600;
    color: #3f4d5a;
    margin: 0 0 8px 0;
    padding-bottom: 8px;
    border-bottom: 1px solid #e3eaf0;
}

.quick-search-widget-section-title svg {
    width: 16px;
    height: 16px;
    color: #8496ab;
}

.quick-search-widget-list {
    list-style: none;
    margin: 0;
    padding: 0;
}

.quick-search-widget-item {
    margin: 0;
    padding: 0;
}

.quick-search-widget-link {
    display: block;
    padding: 8px 10px;
    margin: 0 -10px;
    border-radius: 4px;
    text-decoration: none;
    transition: background 0.1s ease;
}

.quick-search-widget-link:hover {
    background: #f3f7fc;
    text-decoration: none;
}

.quick-search-widget-title {
    display: block;
    font-size: 13px;
    font-weight: 500;
    color: #1c2e36;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.quick-search-widget-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 2px;
    font-size: 11px;
    color: #8496ab;
    flex-wrap: wrap;
}

.quick-search-widget-section-name {
    color: #5c7080;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 150px;
}

.quick-search-widget-status {
    font-size: 10px;
    padding: 1px 5px;
    border-radius: 3px;
    text-transform: capitalize;
}

.quick-search-widget-status.live {
    background: #d4edda;
    color: #155724;
}

.quick-search-widget-status.pending {
    background: #fff3cd;
    color: #856404;
}

.quick-search-widget-status.draft {
    background: #e3eaf0;
    color: #5c7080;
}

.quick-search-widget-status.disabled,
.quick-search-widget-status.expired {
    background: #f8d7da;
    color: #721c24;
}

.quick-search-widget-empty {
    font-size: 12px;
    color: #8496ab;
    margin: 8px 0;
    font-style: italic;
}

.quick-search-widget-show-more {
    margin-top: 8px;
    text-align: center;
}

.quick-search-widget-show-more .btn {
    font-size: 11px;
}

.quick-search-widget-footer {
    padding-top: 12px;
    border-top: 1px solid #e3eaf0;
    text-align: center;
}

.quick-search-widget-footer .btn {
    display: inline-flex;
    align-items: center;
    font-size: 11px;
    padding: 5px 10px;
    white-space: nowrap;
    max-width: 100%;
    overflow: hidden;
}

.quick-search-widget-footer .btn svg {
    flex-shrink: 0;
}

.quick-search-widget-shortcut {
    margin-left: 6px;
    font-size: 9px;
    background: #e3eaf0;
    padding: 1px 4px;
    border-radius: 2px;
    font-family: monospace;
    color: #5c7080;
    flex-shrink: 0;
}

/* Search Section */
.quick-search-widget-search {
    margin-bottom: 16px;
}

.quick-search-widget-search-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}

.quick-search-widget-search-icon {
    position: absolute;
    left: 10px;
    width: 16px;
    height: 16px;
    color: #8496ab;
    pointer-events: none;
}

.quick-search-widget-search-input {
    width: 100%;
    height: 36px;
    padding: 0 12px 0 34px;
    font-size: 13px;
    border: 1px solid #cdd8e4;
    border-radius: 4px;
    outline: none;
    transition: border-color 0.15s ease, box-shadow 0.15s ease;
}

.quick-search-widget-search-input:focus {
    border-color: #0d78f2;
    box-shadow: 0 0 0 2px rgba(13, 120, 242, 0.15);
}

.quick-search-widget-search-input::placeholder {
    color: #8496ab;
}

.quick-search-widget-results {
    margin-top: 8px;
    max-height: 250px;
    overflow-y: auto;
    border: 1px solid #e3eaf0;
    border-radius: 4px;
    background: #fff;
}

.quick-search-widget-results-loading,
.quick-search-widget-results-empty {
    padding: 12px;
    text-align: center;
    color: #8496ab;
    font-size: 12px;
}

.quick-search-widget-results .quick-search-widget-list {
    margin: 0;
    padding: 4px 0;
}

.quick-search-widget-results .quick-search-widget-item {
    padding: 0 4px;
}

.quick-search-widget-results .quick-search-widget-link {
    margin: 0;
    padding: 8px 10px;
}
</style>

<script>
(function() {
    'use strict';

    const utils = window.QuickSearchUtils;
    const debounceTimers = {};

    function initWidgetSearch() {
        document.querySelectorAll('.quick-search-widget-search-input').forEach(input => {
            if (input.dataset.initialized) return;
            input.dataset.initialized = 'true';

            const widgetId = input.dataset.widgetSearch;
            const resultsContainer = document.querySelector(`[data-widget-results="${widgetId}"]`);

            if (!resultsContainer) return;

            input.addEventListener('input', function() {
                const query = this.value.trim();

                if (debounceTimers[widgetId]) {
                    clearTimeout(debounceTimers[widgetId]);
                }

                if (query.length < 2) {
                    resultsContainer.style.display = 'none';
                    resultsContainer.innerHTML = '';
                    return;
                }

                debounceTimers[widgetId] = setTimeout(() => {
                    performSearch(query, resultsContainer);
                }, 300);
            });

            input.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    this.value = '';
                    resultsContainer.style.display = 'none';
                    resultsContainer.innerHTML = '';
                }
            });
        });
    }

    async function performSearch(query, resultsContainer) {
        resultsContainer.style.display = 'block';
        resultsContainer.innerHTML = '<div class="quick-search-widget-results-loading">Searching...</div>';

        try {
            const searchUrl = Craft.getActionUrl('quick-search/search/index');
            const separator = searchUrl.includes('?') ? '&' : '?';
            const params = new URLSearchParams({ query });

            const response = await utils.fetchWithTimeout(
                searchUrl + separator + params.toString(),
                {
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                },
                10000
            );

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();

            if (data.success && data.results && data.results.length > 0) {
                renderResults(data.results, resultsContainer);
            } else {
                resultsContainer.innerHTML = '<div class="quick-search-widget-results-empty">No entries found</div>';
            }
        } catch (error) {
            console.error('Widget search error:', error);
            resultsContainer.innerHTML = '<div class="quick-search-widget-results-empty">Search failed</div>';
        }
    }

    function renderResults(results, container) {
        const list = document.createElement('ul');
        list.className = 'quick-search-widget-list';

        results.slice(0, 10).forEach(entry => {
            const item = document.createElement('li');
            item.className = 'quick-search-widget-item';

            const link = document.createElement('a');
            link.href = entry.url || '#';
            link.className = 'quick-search-widget-link';

            const title = document.createElement('span');
            title.className = 'quick-search-widget-title';
            title.textContent = entry.title || '';

            const meta = document.createElement('span');
            meta.className = 'quick-search-widget-meta';

            const section = document.createElement('span');
            section.className = 'quick-search-widget-section-name';
            section.textContent = entry.section?.name || '';

            const status = document.createElement('span');
            status.className = 'quick-search-widget-status ' + (entry.status || '');
            status.textContent = entry.status || '';

            meta.appendChild(section);
            meta.appendChild(status);

            link.appendChild(title);
            link.appendChild(meta);
            item.appendChild(link);
            list.appendChild(item);
        });

        container.innerHTML = '';
        container.appendChild(list);
    }

    // Initialize on DOM ready and after AJAX updates
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initWidgetSearch);
    } else {
        initWidgetSearch();
    }

    // Re-initialize when widgets are refreshed
    if (typeof Craft !== 'undefined' && Craft.cp) {
        Craft.cp.on('widgetManagerReady', initWidgetSearch);
    }
})();
</script>
